<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alchemical‑Dictionaries • Analysis Tool (Prototype)</title>
  <style>
    :root {
      --bg: #f7f7f9;
      --primary: #24292f;
      --accent: #0d6efd;
      --card: #ffffff;
      --shadow: 0 1px 3px rgba(0,0,0,.1);
    }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--primary);
      display: flex;
      flex-direction: column;
      height: 100dvh;
    }
    header {
      background: var(--card);
      box-shadow: var(--shadow);
      padding: .5rem 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    header h1 {
      font-size: 1.1rem;
      margin: 0;
      white-space: nowrap;
    }
    header nav a {
      text-decoration: none;
      color: var(--primary);
      padding: .25rem .5rem;
      border-radius: .25rem;
    }
    header nav a.active {
      background: var(--accent);
      color: #fff;
    }
    #searchInput {
      flex: 1 1 auto;
      padding: .25rem .5rem;
      border: 1px solid #ccc;
      border-radius: .25rem;
    }
    main {
      flex: 1 1 auto;
      overflow-y: auto;
      padding: 1rem;
    }
    .card {
      background: var(--card);
      border-radius: .5rem;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: var(--shadow);
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td { padding: .25rem .5rem; }
    tr:nth-child(even) { background: #f2f2f2; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script>
</head>
<body>
  <header>
    <h1>Alchemical Dictionaries</h1>
    <input id="searchInput" type="search" placeholder="Search lemmas & definitions…" />
    <nav>
      <a href="#/search" id="tab-search">Search</a>
      <a href="#/symbols" id="tab-symbols">Symbols</a>
      <a href="#/network" id="tab-network">Network</a>
      <a href="#/timeline" id="tab-timeline">Timeline</a>
    </nav>
  </header>
  <main id="app">
    <p>Loading data …</p>
  </main>

  <script type="module">
    /**************** DataStore (same as previous update, condensed) ****************/
    class DataStore {
      static #instance = null;
      static async init() {
        if (!this.#instance) { this.#instance = new DataStore(); await this.#instance.#loadAll(); }
        return this.#instance;
      }
      #entries=[]; #symbols=[]; #graph={nodes:[],edges:[]}; #lunr=null; #idMap=new Map(); #normMap=new Map();
      async #json(p){const r=await fetch(p); if(!r.ok)throw new Error(p); return r.json();}
      async #ndjson(p){const r=await fetch(p); if(!r.ok)throw new Error(p); return (await r.text()).trim().split(/\n+/).map(JSON.parse);}
      async #loadAll(){const [e,s,g,i]=await Promise.all([this.#ndjson('./data/entries.ndjson'),this.#json('./data/symbols.json'),this.#json('./data/graph.json'),this.#json('./data/index.json')]); this.#entries=e;this.#symbols=s;this.#graph=g;this.#lunr=lunr.Index.load(i);e.forEach(ent=>{this.#idMap.set(ent.id,ent);if(ent.lemma_norm)this.#normMap.set(ent.lemma_norm,ent);});}
      get entries(){return this.#entries;} get symbols(){return this.#symbols;} get graph(){return this.#graph;}
      getEntry(id){return this.#idMap.get(id)||null;}
      findByLemma(raw){const n=raw.toLowerCase().normalize('NFD').replace(/\p{M}/gu,''); return this.#normMap.get(n)||null;}
      search(q){return q.trim()? this.#lunr.search(q).map(h=>this.getEntry(h.ref)) : [];} }
    window.DataStore=DataStore;

    /******************* Simple client‑side router *************************/
    const routes = {
      '/search': renderSearch,
      '/symbols': renderSymbols,
      '/network': renderNetwork,
      '/timeline': renderTimeline
    };
    function navigate(){ const hash=location.hash||'#/search'; const path=hash.replace('#',''); document.querySelectorAll('header nav a').forEach(a=>a.classList.toggle('active',a.getAttribute('href')===hash)); routes[path]?.(); }
    window.addEventListener('hashchange', navigate);

    /************************* Renderers *************************/
    const app=document.getElementById('app');

    let store=null; // populated after load

    async function ensureStore(){ if(!store){ store=await DataStore.init(); } }

    async function renderSearch(){ await ensureStore(); app.innerHTML=''; const q=document.getElementById('searchInput').value; const results=store.search(q).slice(0,50);
      const container=document.createElement('div'); container.className='card';
      container.innerHTML=`<h2>Search results (${results.length})</h2>`;
      if(!results.length){ container.insertAdjacentHTML('beforeend','<p>No results. Try another query.</p>'); }
      const ul=document.createElement('ul'); results.forEach(e=>{ const li=document.createElement('li'); li.textContent=`${e.lemma} – ${(e.translations||[]).join('; ').slice(0,80)}`; ul.appendChild(li);}); container.appendChild(ul); app.appendChild(container); }

    async function renderSymbols(){ await ensureStore(); app.innerHTML=''; const grid=document.createElement('table'); grid.className='card'; grid.innerHTML='<tr><th>Glyph</th><th>Code</th><th>Lemma count</th></tr>';
      store.symbols.slice(0,50).forEach(g=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${g.svg?'<img src="'+g.svg+'" width="24"/>':g.char||''}</td><td>${g.code||''}</td><td>${g.entries?.length||0}</td>`; grid.appendChild(tr);}); app.appendChild(grid);}    

    async function renderNetwork(){ await ensureStore(); app.innerHTML=''; const c=document.createElement('div'); c.className='card'; c.innerHTML=`<h2>Graph summary</h2><p>Nodes: ${store.graph.nodes.length} | Edges: ${store.graph.edges.length}</p><p>(Interactive vis TBD)</p>`; app.appendChild(c);}    

    async function renderTimeline(){ await ensureStore(); app.innerHTML=''; const c=document.createElement('div'); c.className='card'; c.innerHTML='<h2>Timeline</h2><p>Heat‑map visualisation stub – to be implemented.</p>'; app.appendChild(c);}    

    /*********************** Input events *************************/
    document.getElementById('searchInput').addEventListener('keydown',e=>{ if(e.key==='Enter'){location.hash='#/search';}});

    /*********************** Minimal test harness *************************/
    async function runTests(){ await ensureStore(); const assert=(cond,msg)=>{ if(!cond)throw new Error(msg); }; try{
        assert(store.entries.length===20576,'entry count');
        assert(store.symbols.length===294,'symbol count');
        assert(store.graph.edges.length>0,'graph edges');
        const aqua=store.search('"aqua fortis"'); assert(aqua.length>0,'search returns');
        console.log('%cAll smoke tests passed!','color:green');
      }catch(e){ console.error('Test failed:',e.message);} }
    window.runTests=runTests;

    /******************** bootstrap ***************************/
    navigate(); // first render (may show loading)
    ensureStore().then(()=>{
      document.getElementById('searchInput').disabled=false;
      if(location.hash==='') location.hash='#/search';
      runTests();
    });
  </script>
</body>
</html>
